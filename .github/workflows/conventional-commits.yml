name: conventional-commits

on:
  pull_request:
  push:

jobs:
  check-commit-messages:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate commit subjects
        env:
          EVENT_NAME: ${{ github.event_name }}
          BASE_REF: ${{ github.base_ref }}
          BEFORE_SHA: ${{ github.event.before }}
          HEAD_SHA: ${{ github.sha }}
        run: |
          set -euo pipefail

          if [[ "$EVENT_NAME" == "pull_request" ]]; then
            git fetch --no-tags --prune origin "$BASE_REF"
            RANGE="origin/$BASE_REF..HEAD"
          else
            if [[ "${BEFORE_SHA:-}" =~ ^0+$ ]]; then
              RANGE="$HEAD_SHA"
            else
              RANGE="$BEFORE_SHA..$HEAD_SHA"
            fi
          fi

          regex='^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([a-z0-9._/-]+\))?!?: .+'
          failed=0

          while IFS= read -r subject; do
            [[ -z "$subject" ]] && continue
            if [[ ! "$subject" =~ $regex ]]; then
              echo "::error::Non-conventional commit subject: $subject"
              failed=1
            fi
          done < <(git log --format=%s "$RANGE")

          if [[ "$failed" -ne 0 ]]; then
            echo "Commit messages must follow Conventional Commits."
            exit 1
          fi
